import type { NextApiRequest, NextApiResponse } from 'next';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  const { theme, mood } = req.body;
  if (!theme || !mood) {
    res.status(400).json({ error: 'テーマと雰囲気は必須です' });
    return;
  }

  try {
    const prompt = `
    # タスク
    あなたはゲームマスターです。以下の条件で、テーマ「${theme}」、雰囲気「${mood}」に合ったシーン表を日本語で作成してください。

    # 背景・ゲームの説明
    * タイトル：忍術バトルRPG「シノビガミ」
    * ゲームキャラクターの設定：現代の裏側に潜む影の住人「忍者」たち
    * シーン表の用途：忍者たちが日常生活を送ったり、情報の調査活動を行うシーンの大雑把な雰囲気を決めるために「シーン表」を使います。

    # 出力形式
    * 2から12まで、全部で11個のシーンを作成します。
    * 11個のシーンはいずれもこちらから与えた「テーマ」に沿ったものである必要があります。

    # 出力ルール
    * 各シーンには【番号】【シーンの状況説明（1文〜2文／100〜150文字程度）】を記載すること
    * 番号は2〜12で統一すること
    * 同じ種類のシーンが連続しないよう、雰囲気・場所・状況にバリエーションを持たせること

    # テーマ・雰囲気
    * テーマ：${theme}
    * 雰囲気：${mood}

    # 注意事項
    * プレイヤーの行動を促す「選択肢の余地」や「状況の余韻」を残す描写を意識すること
    * 同一テーマ内でもできるだけバリエーション豊かな状況を配置すること

    # 出力例1 テーマ：喫茶店　雰囲気：平和
    /roll-table
    喫茶店シーン表
    2d6
    2:開店直後の静かな時間。カウンターの奥でマスターがコーヒーを淹れる音だけが響いている。忍びもここでは一人の客だ。
    3:奥のソファ席で読書をする常連の老人。忍者たちに気づいているのかいないのか、どこか達観したような空気をまとっている。
    4:ガラス越しに差し込む陽射しがテーブルを照らす午後のひととき。注文したパフェが意外に豪勢で、少し戸惑う。
    5:BGM代わりのジャズがゆったりと流れる中、仲間と無言でコーヒーをすする。言葉より、空気の共有が心地よい。
    6:マスターに勧められて頼んだ期間限定メニュー。想像以上に美味しくて、任務中であることを忘れそうになる。
    7:手書きのメニューや飾られたドライフラワーに、店主の細やかなこだわりを感じる。忍びの感性も思わず和む。
    8:アルバイトの少女が出すお冷やと一緒に、飴玉をそっと一つ。店主なりのささやかな気遣いに、微笑みがこぼれる。
    9:店内に流れるテレビのニュースでは、どこか遠くの騒動が報じられている。それでもここは、穏やかな時間が流れている。
    10:カップを置いた瞬間、小さく鈴の音がした気がした。誰かが入ってきたのか、空耳か。穏やかな空気はそのままだ。
    11:二階の窓際席。外を行き交う人々を眺めながら、忍者としての「今」を少しだけ忘れることができる場所。
    12:閉店間際の喫茶店。常連たちは帰り、最後の一杯が静かにテーブルに置かれる。今日も何事もなく過ぎた一日に、ほっとする。

    # 出力例2 テーマ：温泉旅館　雰囲気：不穏
    /roll-table
    温泉旅館シーン表
    2d6
    2:湯けむりが立ち込める露天風呂。心地よい湯音の裏に、微かに聞こえる水面を裂くような音が耳に残る。誰か、潜んでいるのか。
    3:宴会場では賑やかな宴が行われているが、酌をする仲居の視線が妙に鋭く感じる。どうにも気を抜けない空気だ。
    4:長い畳敷きの廊下。足音を殺して歩いていると、誰かの影が角の向こうに消えたように見えた。
    5:旅館の裏手、古びた祠。苔むした鳥居と誰もいないはずの境内に、微かな足跡が残されている。
    6:客室の一室。窓の外に広がる山の景色は静かだが、障子の向こうからかすかに息遣いのようなものが……。
    7:土産物売り場。色とりどりの菓子や工芸品が並ぶ中、不自然に品物の間に差し込まれた小さな巻物を見つける。
    8:誰もいない深夜の脱衣所。棚に残された濡れた手拭いと、曇った鏡に浮かぶ不審な文字。
    9:夕暮れの足湯場。他の客の姿はなく、湯面に落ちる赤い夕陽が妙に不吉に揺らめく。
    10:調理場の裏口。食材の匂いに紛れて、血のような鉄錆の臭いが漂う。誰かがついさっきまでいた気配が残っている。
    11:物置小屋。昔使われていたらしい忍び道具が打ち捨てられており、埃まみれの中にひときわ新しい手裏剣が。
    12:旅館の離れにある秘密の間。掛け軸の裏から抜け穴が覗いている。そこからどこかへと続いているようだ。
    `;
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: 'あなたは優秀なTRPGゲームマスターです。' },
        { role: 'user', content: prompt },
      ],
      max_tokens: 1500,
    });
    const result = completion.choices[0].message?.content || '';
    res.status(200).json({ sceneTable: result });
  } catch (error: any) {
    res.status(500).json({ error: error.message || 'OpenAI APIエラー' });
  }
} 